name: 'ðŸª„ Gemini Fixer'

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string
        description: 'The issue number to fix'

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  fix:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: 'Mint identity token'
        id: 'mint_identity_token'
        if: ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@v1'
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          owner: ${{ github.repository_owner }}

      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'

      - name: 'Run Gemini Fixer'
        uses: 'google-github-actions/run-gemini-cli@v0'
        id: 'gemini_fix'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ inputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
        with:
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          settings: |-
            {
              "model": {
                "maxSessionTurns": 50
              },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server:v0.18.0"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              }
            }
          prompt: '/gemini-issue-fixer'
