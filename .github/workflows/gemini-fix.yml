name: 'ðŸª„ Gemini Fixer'

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string
        description: 'The issue number to fix'
      comment_id:
        required: false
        type: string
        description: 'The comment ID'
      prompt:
        required: false
        type: string
        description: 'Optional user prompt'
      triage_tdd_level:
        description: 'TDD enforcement level: "advisory" (default) or "strict"'
        required: false
        type: string
        default: 'advisory'

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  fix:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: 'Mint identity token'
        id: 'mint_identity_token'
        if: ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@v1'
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          owner: ${{ github.repository_owner }}

      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'

      - name: 'Run Gemini Fixer'
        uses: 'google-github-actions/run-gemini-cli@v0'
        id: 'gemini_fix'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ inputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
        with:
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          extensions: 'local:.gemini/extensions/smart_replace'
          settings: |-
            {
              "model": {
                "maxSessionTurns": 50
              },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server:v0.18.0"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              }
            }
          prompt: |
            You are the Gemini Issue Fixer. You are fixing Issue #${{ inputs.issue_number }}.
            
            USER PROMPT: "${{ inputs.prompt }}"
            TDD LEVEL: "${{ inputs.triage_tdd_level }}"
            
            INSTRUCTIONS:
            1. Analyze the issue description.
            2. Explore the codebase to locate the bug.
            
            ### TDD Guidelines (${{ inputs.triage_tdd_level }})
            
            **Advisory Anti-Patterns**:
            - "The Liar": Tests pass but don't test behavior.
            - "The Follower": Writing tests after code.
            - "The Giant": One huge test.
            
            **STRICT MODE (Iron Law)**:
            If `TDD LEVEL` is "strict", you MUST NOT write any fix code without a failing test.
            - 1. Create a reproduction test case that fails.
            - 2. Verify it fails (RED).
            - 3. Fix the bug.
            - 4. Verify it passes (GREEN).
            
            3. **CRITICAL**: Use the `smart_replace` tool to fix the bug. It uses fuzzy matching to be safer than standard tools.
            4. Verify your fix if possible (e.g. by considering tests).
            5. Commit and push your changes to a new branch `fix/issue-${{ inputs.issue_number }}`.
            6. Create a Pull Request closing the issue.
